
---

근데 그럼 이 토큰은 언제 만료되는거지?

그럼 사용자 모르게 매번 새로 토큰을 발급받아야 한다고?



FCM 토큰을 어떻게 관리해야 하지?

친절하게 팁에 토큰을 관리하는 Best Practice가 있다.

https://firebase.google.com/docs/cloud-messaging/manage-tokens?hl=ko

FCM 토큰 관리 팁

1. FCM에서 등록 토큰을 검색하여 서버에 저장합니다.
2. 토큰 정보를 저장할 때, 토큰과 함께 타임스탬프를 저장합니다.
3. 토큰을 최신 상태로 유지하고 비활성 토큰을 삭제합니다.
4. 토큰이 변경될 때마다 서버에서 타임스탬프를 업데이트해야 한다.
    - 새 기기에서 앱 복원
    - 사용자가 앱 제거 또는 재설치
    - 사용자가 앱 데이터 소거
    - FCM에서 기존 토큰이 만료된 후 앱이 다시 활성화

![img_2.png](토큰과%20타임스탬프%20함께%20저장할%20것.png)

1. 기기 정보를 무엇으로 식별할 것인가?
2. 기기 ID는 어떻게 보관할 것인가?

현재 예제는 회원 별 FCM 토큰을 DB에 저장하고 있다.

그런데 사용자는 하나의 기기만 사용하는 것이 아닌, 여러 기기를 사용할 수 있다.

따라서 회원 당 여러 개의 FCM 토큰을 저장할 수 있도록 설계해야 한다.

그러면 사용자의 "기기 별"로 FCM 토큰을 관리/업데이트할 수 있다.

- 사용자 1 - N FCN 토큰 바로 매핑이 아닌, 사용자 1 - N 기기 1 - 1 FCM 토큰 구조로 설계해야 한다.


사용자의 기기 정보를 어떻게 저장하지?

- 앱들의 경우, Keychain/Keystore 로 기기 정보를 안전하게 저장할 수 있다.
- 하지만, PWA는 “네이티브 보안 저장소”가 없다고 보는 것이 안전하며,
    - 인증은 HttpOnly 쿠키 기반 세션,
    - 단순 식별은 IndexedDB에 UUID 저장

이게 그나마 안전한 방법이다.